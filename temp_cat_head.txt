// screens/category_selection_screen.dart
import 'package:flutter/material.dart';
import '../models/category_model.dart';
import '../models/room_model.dart';
import '../models/user_model.dart';
import '../utils/constants.dart';
import 'game_screen.dart';
import '../services/lobby_service.dart';
import 'dart:async';

class CategorySelectionScreen extends StatefulWidget {
  final GameRoom room;
  final UserModel user;

  const CategorySelectionScreen({
    super.key,
    required this.room,
    required this.user,
  });

  @override
  State<CategorySelectionScreen> createState() =>
      _CategorySelectionScreenState();
}

class _CategorySelectionScreenState extends State<CategorySelectionScreen> {
  final LobbyService _lobbyService = LobbyService();
  StreamSubscription<GameRoom?>? _roomSub;
  bool _navigatedToGame = false;
  final List<Category> _availableCategories = [
    Category(
      id: '1',
      name: 'General Knowledge',
      description: 'Test your general knowledge',
      type: CategoryType.trivia,
      challenges: [],
      imageAsset: 'assets/images/general_knowledge.png',
    ),
    Category(
      id: '2',
      name: 'Family Life',
      description: 'Fun questions about family',
      type: CategoryType.trivia,
      challenges: [],
      imageAsset: 'assets/images/family.png',
    ),
    Category(
      id: '3',
      name: 'Gulf Culture',
      description: 'Questions about Gulf traditions',
      type: CategoryType.trivia,
      challenges: [],
      imageAsset: 'assets/images/gulf.png',
    ),
    Category(
      id: '4',
      name: 'Movies & TV',
      description: 'Guess movies and TV shows',
      type: CategoryType.trivia,
      challenges: [],
      imageAsset: 'assets/images/movie.png',
    ),
    Category(
      id: '5',
      name: 'Music',
      description: 'Music trivia and karaoke',
      type: CategoryType.karaoke,
      challenges: [],
      imageAsset: 'assets/images/music.png',
    ),
    Category(
      id: '6',
      name: 'Funny Challenges',
      description: 'Hilarious physical challenges',
      type: CategoryType.physical,
      challenges: [],
      imageAsset: 'assets/images/funny_challenge.png',
    ),
    Category(
      id: '7',
      name: 'Kids Corner',
      description: 'Fun for the little ones',
      type: CategoryType.trivia,
      challenges: [],
      imageAsset: 'assets/images/kids_corner.png',
    ),
    Category(
      id: '8',
      name: 'Quick Thinking',
      description: 'Fast-paced brain teasers',
      type: CategoryType.trivia,
      challenges: [],
      imageAsset: 'assets/images/quick_thinking.png',
    ),
  ];

  final List<Category> _selectedCategories = [];

  bool get _isHost => widget.user.id == widget.room.hostId;

  @override
  void initState() {
    super.initState();
    // Start with any existing selections
    _selectedCategories.addAll(widget.room.selectedCategories);
    // Everyone listens: host and joiners
    _roomSub = _lobbyService.getRoomStream(widget.room.code).listen((room) {
      if (!mounted || room == null) return;
      // Reflect live selections from host
      setState(() {
        // Replace local view with latest from backend
        _selectedCategories
          ..clear()
          ..addAll(room.selectedCategories);
      });
      // Transition to game for all when host starts
      if (!_navigatedToGame && room.state == GameState.inGame) {
        _navigatedToGame = true;
        Navigator.pushReplacement(
          context,
          MaterialPageRoute(
            builder: (context) => GameScreen(
              room: room,
              user: widget.user,
              isHost: _isHost,
            ),
          ),
        );
      }
    });
  }

  @override
  void dispose() {
    _roomSub?.cancel();
    super.dispose();
  }

  void _toggleCategory(Category category) {
    if (!_isHost) return; // joiners are read-only here
    setState(() {
      if (_selectedCategories.contains(category)) {
        _selectedCategories.remove(category);
      } else {
        if (_selectedCategories.length < 8) {
          _selectedCategories.add(category);
        } else {
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Maximum 8 categories allowed')),
          );
        }
      }
    });
    // Broadcast live selection so joiners can see
    _lobbyService.updateSelectedCategories(
        widget.room.code, List<Category>.from(_selectedCategories));
  }

  void _startGame() {
    if (!_isHost) return;
    if (_selectedCategories.length < 5) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Please select at least 5 categories')),
      );
      return;
    }
    // Persist categories and advance state; listeners will navigate
    _lobbyService.finalizeCategoriesAndStart(
        widget.room.code, List<Category>.from(_selectedCategories));
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppConstants.backgroundColor,
      appBar: AppBar(
        title: const Text('Select Categories'),
        backgroundColor: const Color(0xFFCE1126),
      ),
      body: Column(
        children: [
          // Header
          Container(
            padding: const EdgeInsets.all(16),
            color: Colors.white,
            child: Column(
              children: [
                Text(
                  'Select 5-8 Categories',
                  style: TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: AppConstants.primaryBlack,
                  ),
                ),
                const SizedBox(height: 8),
                Text(
                  '${_selectedCategories.length} selected (Min: 5, Max: 8)',
                  style: TextStyle(
                    color: _selectedCategories.length >= 5
                        ? Colors.green
                        : Colors.orange,
                    fontWeight: FontWeight.bold,
                  ),
                ),
              ],
            ),
          ),

          // Categories Grid
          Expanded(
            child: GridView.builder(
              padding: const EdgeInsets.all(16),
              gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                crossAxisCount: 2,
                crossAxisSpacing: 12,
                mainAxisSpacing: 12,
                // Fix overflow: slightly reduce aspect ratio for better fit
                childAspectRatio: 0.90,
              ),
              itemCount: _availableCategories.length,
              itemBuilder: (context, index) {
                final category = _availableCategories[index];
                final isSelected = _selectedCategories.contains(category);

                return _buildCategoryCard(category, isSelected);
              },
            ),
          ),

          // Start Game Button
          Container(
            padding: const EdgeInsets.all(16),
            child: SizedBox(
              width: double.infinity,
              child: _isHost
                  ? ElevatedButton(
                      onPressed:
                          _selectedCategories.length >= 5 ? _startGame : null,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFF007A3D),
                        padding: const EdgeInsets.symmetric(vertical: 16),
                      ),
                      child: Text(
                        'Start Game (${_selectedCategories.length}/5)',
                        style: const TextStyle(
                            fontSize: 18, fontWeight: FontWeight.bold),
                      ),
                    )
                  : const Text(
                      'Waiting for host to select categories...',
                      textAlign: TextAlign.center,
                      style: TextStyle(fontSize: 16, color: Colors.grey),
                    ),
            ),
          ),
        ],
      ),
    );
  }
